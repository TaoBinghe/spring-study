package com.coder;

import com.coder.config.SpringConfig;
import com.coder.domain.TransferLog;
import com.coder.service.TransferLogService;
import com.coder.service.impl.AccountServiceImplWithError;
import org.springframework.context.ApplicationContext;
import org.springframework.context.annotation.AnnotationConfigApplicationContext;

import java.util.List;

/**
 * Springäº‹åŠ¡ä¼ æ’­è¡Œä¸ºæ¼”ç¤ºç¨‹åº
 *
 * æœ¬ç¨‹åºé€šè¿‡å¯¹æ¯”å®éªŒï¼Œæ¼”ç¤ºREQUIREDå’ŒREQUIRES_NEWä¸¤ç§ä¼ æ’­è¡Œä¸ºçš„åŒºåˆ«
 *
 * å®éªŒè®¾è®¡ï¼š
 * ============================================================================
 * å®éªŒ1ï¼šREQUIREDä¼ æ’­è¡Œä¸º
 *   - æˆåŠŸåœºæ™¯ï¼šè½¬è´¦æˆåŠŸï¼Œæ—¥å¿—ä¿ç•™
 *   - å¤±è´¥åœºæ™¯ï¼šè½¬è´¦å¤±è´¥ï¼Œæ—¥å¿—å›æ»šï¼ˆæ•°æ®åº“æ— è®°å½•ï¼‰
 *
 * å®éªŒ2ï¼šREQUIRES_NEWä¼ æ’­è¡Œä¸º
 *   - æˆåŠŸåœºæ™¯ï¼šè½¬è´¦æˆåŠŸï¼Œæ—¥å¿—ä¿ç•™
 *   - å¤±è´¥åœºæ™¯ï¼šè½¬è´¦å¤±è´¥ï¼Œæ—¥å¿—ä¿ç•™ï¼ˆæ•°æ®åº“æœ‰è®°å½•ï¼‰
 *
 * è§‚å¯Ÿé‡ç‚¹ï¼š
 * - å¤±è´¥åæŸ¥çœ‹transfer_logè¡¨ï¼Œè§‚å¯Ÿæ—¥å¿—æ˜¯å¦ä¿ç•™
 * - æŸ¥çœ‹accountè¡¨ï¼Œè§‚å¯Ÿä½™é¢æ˜¯å¦å˜åŒ–
 * ============================================================================
 */
public class AppForPropagationDemo {

    public static void main(String[] args) {
        // 1. åŠ è½½Springé…ç½®
        ApplicationContext ctx = new AnnotationConfigApplicationContext(SpringConfig.class);

        // 2. è·å–Bean
        AccountServiceImplWithError accountService = ctx.getBean(AccountServiceImplWithError.class);
        TransferLogService logService = ctx.getBean(TransferLogService.class);

        printBanner();

        // æ¸…ç©ºä¹‹å‰çš„æ—¥å¿—ï¼ˆä¸ºäº†å®éªŒæ¸…æ™°ï¼‰
        System.out.println("ã€å‡†å¤‡ã€‘è¯·ç¡®ä¿æ•°æ®åº“å·²æ‰§è¡Œinit.sqlå’Œinit_log.sqlåˆå§‹åŒ–è„šæœ¬\n");

        // ============================================================================
        // å®éªŒ1ï¼šREQUIREDä¼ æ’­è¡Œä¸º
        // ============================================================================
        System.out.println("â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—");
        System.out.println("â•‘  å®éªŒ1ï¼šREQUIREDä¼ æ’­è¡Œä¸º - æ—¥å¿—ä¸ä¸šåŠ¡åŒç”Ÿå…±æ­»                        â•‘");
        System.out.println("â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");

        // 1.1 æˆåŠŸåœºæ™¯
        System.out.println("\nã€åœºæ™¯1.1ã€‘è½¬è´¦æˆåŠŸ - REQUIREDæ¨¡å¼");
        System.out.println("é¢„æœŸç»“æœï¼šè½¬è´¦æˆåŠŸï¼Œtransfer_logè¡¨æœ‰1æ¡è®°å½•");
        System.out.println("-".repeat(60));
        try {
            accountService.transferWithLogRequired("å¼ ä¸‰", "æå››", 100.0);
        } catch (Exception e) {
            System.out.println("å¼‚å¸¸ï¼š" + e.getMessage());
        }
        printLogs(logService);

        // 1.2 å¤±è´¥åœºæ™¯
        System.out.println("\nã€åœºæ™¯1.2ã€‘è½¬è´¦å¤±è´¥ - REQUIREDæ¨¡å¼");
        System.out.println("é¢„æœŸç»“æœï¼šè½¬è´¦å¤±è´¥ï¼ˆå›æ»šï¼‰ï¼Œtransfer_logè¡¨æ— æ–°å¢è®°å½•ï¼ˆæ—¥å¿—ä¹Ÿå›æ»šï¼‰");
        System.out.println("-".repeat(60));
        try {
            accountService.transferWithLogRequiredAndFail("å¼ ä¸‰", "æå››", 50.0);
        } catch (Exception e) {
            System.out.println("æ•è·å¼‚å¸¸ï¼ˆé¢„æœŸï¼‰ï¼š" + e.getMessage());
            System.out.println("ã€å…³é”®è§‚å¯Ÿã€‘è™½ç„¶æ—¥å¿—æ–¹æ³•å·²æ‰§è¡Œï¼Œä½†ç”±äºREQUIREDä¼ æ’­è¡Œä¸ºï¼Œ");
            System.out.println("          æ—¥å¿—è®°å½•éšä¸»äº‹åŠ¡ä¸€èµ·å›æ»šäº†ï¼");
        }
        printLogs(logService);

        // ============================================================================
        // å®éªŒ2ï¼šREQUIRES_NEWä¼ æ’­è¡Œä¸º
        // ============================================================================
        System.out.println("\nâ•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—");
        System.out.println("â•‘  å®éªŒ2ï¼šREQUIRES_NEWä¼ æ’­è¡Œä¸º - æ—¥å¿—ç‹¬ç«‹ä¿å­˜                          â•‘");
        System.out.println("â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");

        // 2.1 æˆåŠŸåœºæ™¯
        System.out.println("\nã€åœºæ™¯2.1ã€‘è½¬è´¦æˆåŠŸ - REQUIRES_NEWæ¨¡å¼");
        System.out.println("é¢„æœŸç»“æœï¼šè½¬è´¦æˆåŠŸï¼Œtransfer_logè¡¨æœ‰å¤šæ¡è®°å½•");
        System.out.println("-".repeat(60));
        try {
            accountService.transferWithLogRequiresNew("æå››", "å¼ ä¸‰", 200.0);
        } catch (Exception e) {
            System.out.println("å¼‚å¸¸ï¼š" + e.getMessage());
        }
        printLogs(logService);

        // 2.2 å¤±è´¥åœºæ™¯
        System.out.println("\nã€åœºæ™¯2.2ã€‘è½¬è´¦å¤±è´¥ - REQUIRES_NEWæ¨¡å¼");
        System.out.println("é¢„æœŸç»“æœï¼šè½¬è´¦å¤±è´¥ï¼ˆå›æ»šï¼‰ï¼Œä½†transfer_logè¡¨æœ‰æ–°å¢è®°å½•ï¼ˆæ—¥å¿—ç‹¬ç«‹æäº¤ï¼‰");
        System.out.println("-".repeat(60));
        try {
            accountService.transferWithLogRequiresNewAndFail("æå››", "å¼ ä¸‰", 100.0);
        } catch (Exception e) {
            System.out.println("æ•è·å¼‚å¸¸ï¼ˆé¢„æœŸï¼‰ï¼š" + e.getMessage());
            System.out.println("ã€å…³é”®è§‚å¯Ÿã€‘è™½ç„¶è½¬è´¦å¤±è´¥äº†ï¼Œä½†ç”±äºREQUIRES_NEWä¼ æ’­è¡Œä¸ºï¼Œ");
            System.out.println("          æ—¥å¿—è®°å½•åœ¨ç‹¬ç«‹äº‹åŠ¡ä¸­å·²æäº¤ï¼Œä¸ä¼šå›æ»šï¼");
        }
        printLogs(logService);

        // ============================================================================
        // æ€»ç»“
        // ============================================================================
        printSummary();

        // å…³é—­å®¹å™¨
        ((AnnotationConfigApplicationContext) ctx).close();
    }

    /**
     * æ‰“å°ç¨‹åºæ¨ªå¹…
     */
    private static void printBanner() {
        System.out.println("â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—");
        System.out.println("â•‘                                                                    â•‘");
        System.out.println("â•‘        Springäº‹åŠ¡ä¼ æ’­è¡Œä¸ºæ•™å­¦æ¼”ç¤º                                    â•‘");
        System.out.println("â•‘        REQUIRED vs REQUIRES_NEW å¯¹æ¯”å®éªŒ                            â•‘");
        System.out.println("â•‘                                                                    â•‘");
        System.out.println("â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");
        System.out.println();
        System.out.println("ğŸ“š å­¦ä¹ ç›®æ ‡ï¼š");
        System.out.println("   1. ç†è§£REQUIREDä¼ æ’­è¡Œä¸ºï¼šæ—¥å¿—ä¸ä¸šåŠ¡åœ¨åŒä¸€ä¸ªäº‹åŠ¡ä¸­ï¼ŒåŒç”Ÿå…±æ­»");
        System.out.println("   2. ç†è§£REQUIRES_NEWä¼ æ’­è¡Œä¸ºï¼šæ—¥å¿—åœ¨ç‹¬ç«‹äº‹åŠ¡ä¸­ï¼Œä¸å—ä¸»ä¸šåŠ¡å½±å“");
        System.out.println("   3. æŒæ¡å®é™…åº”ç”¨åœºæ™¯çš„é€‰æ‹©");
        System.out.println();
    }

    /**
     * æ‰“å°å½“å‰æ—¥å¿—
     */
    private static void printLogs(TransferLogService logService) {
        System.out.println("\nã€å½“å‰transfer_logè¡¨è®°å½•ã€‘");
        List<TransferLog> logs = logService.getAllLogs();
        if (logs.isEmpty()) {
            System.out.println("  æš‚æ— è®°å½•");
        } else {
            System.out.println("  å…± " + logs.size() + " æ¡è®°å½•ï¼š");
            System.out.println("  â”Œâ”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”");
            System.out.println("  â”‚ ID â”‚  è½¬å‡ºæ–¹   â”‚  è½¬å…¥æ–¹   â”‚  é‡‘é¢  â”‚  çŠ¶æ€   â”‚         æ—¶é—´            â”‚");
            System.out.println("  â”œâ”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤");
            for (TransferLog log : logs) {
                System.out.printf("  â”‚ %2d â”‚ %8s â”‚ %8s â”‚ %6.1f â”‚ %7s â”‚ %s |%n",
                        log.getId(),
                        log.getFromAccount(),
                        log.getToAccount(),
                        log.getAmount(),
                        log.getStatus(),
                        log.getCreateTime());
            }
            System.out.println("  â””â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜");
        }
        System.out.println();
    }

    /**
     * æ‰“å°æ€»ç»“
     */
    private static void printSummary() {
        System.out.println("â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—");
        System.out.println("â•‘                           æ•™å­¦æ€»ç»“                                 â•‘");
        System.out.println("â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");
        System.out.println();
        System.out.println("â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”");
        System.out.println("â”‚ REQUIREDä¼ æ’­è¡Œä¸ºï¼ˆé»˜è®¤ï¼‰                                            â”‚");
        System.out.println("â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤");
        System.out.println("â”‚ ç‰¹ç‚¹ï¼š                                                              â”‚");
        System.out.println("â”‚   â€¢ å¦‚æœå½“å‰å­˜åœ¨äº‹åŠ¡ï¼Œåˆ™åŠ å…¥è¯¥äº‹åŠ¡                                   â”‚");
        System.out.println("â”‚   â€¢ å¦‚æœå½“å‰æ²¡æœ‰äº‹åŠ¡ï¼Œåˆ™åˆ›å»ºæ–°äº‹åŠ¡                                   â”‚");
        System.out.println("â”‚                                                                     â”‚");
        System.out.println("â”‚ å®éªŒç»“æœï¼š                                                          â”‚");
        System.out.println("â”‚   âœ“ è½¬è´¦æˆåŠŸ â†’ æ—¥å¿—æäº¤ï¼ˆtransfer_logæœ‰è®°å½•ï¼‰                        â”‚");
        System.out.println("â”‚   âœ— è½¬è´¦å¤±è´¥ â†’ æ—¥å¿—å›æ»šï¼ˆtransfer_logæ— è®°å½•ï¼‰                        â”‚");
        System.out.println("â”‚                                                                     â”‚");
        System.out.println("â”‚ é€‚ç”¨åœºæ™¯ï¼š                                                          â”‚");
        System.out.println("â”‚   â€¢ è®¢å•ä¸è®¢å•æ˜ç»†ï¼ˆå¿…é¡»åŒæ—¶æˆåŠŸæˆ–å¤±è´¥ï¼‰                              â”‚");
        System.out.println("â”‚   â€¢ å¼ºå…³è”çš„ä¸šåŠ¡æ“ä½œ                                                â”‚");
        System.out.println("â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜");
        System.out.println();
        System.out.println("â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”");
        System.out.println("â”‚ REQUIRES_NEWä¼ æ’­è¡Œä¸º                                                â”‚");
        System.out.println("â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤");
        System.out.println("â”‚ ç‰¹ç‚¹ï¼š                                                              â”‚");
        System.out.println("â”‚   â€¢ æ— è®ºå½“å‰æ˜¯å¦å­˜åœ¨äº‹åŠ¡ï¼Œéƒ½åˆ›å»ºæ–°äº‹åŠ¡                               â”‚");
        System.out.println("â”‚   â€¢ å¦‚æœå­˜åœ¨å½“å‰äº‹åŠ¡ï¼Œåˆ™æŒ‚èµ·å½“å‰äº‹åŠ¡                                 â”‚");
        System.out.println("â”‚                                                                     â”‚");
        System.out.println("â”‚ å®éªŒç»“æœï¼š                                                          â”‚");
        System.out.println("â”‚   âœ“ è½¬è´¦æˆåŠŸ â†’ æ—¥å¿—æäº¤ï¼ˆtransfer_logæœ‰è®°å½•ï¼‰                        â”‚");
        System.out.println("â”‚   âœ“ è½¬è´¦å¤±è´¥ â†’ æ—¥å¿—ä»ä¿ç•™ï¼ˆtransfer_logæœ‰è®°å½•ï¼‰                      â”‚");
        System.out.println("â”‚                                                                     â”‚");
        System.out.println("â”‚ é€‚ç”¨åœºæ™¯ï¼š                                                          â”‚");
        System.out.println("â”‚   â€¢ å®¡è®¡æ—¥å¿—ã€æ“ä½œè®°å½•ï¼ˆå¿…é¡»ä¿ç•™ï¼‰                                   â”‚");
        System.out.println("â”‚   â€¢ é“¶è¡Œè½¬è´¦è®°å½•ã€ç™»å½•æ—¥å¿—                                           â”‚");
        System.out.println("â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜");
        System.out.println();
        System.out.println("ğŸ’¡ æ ¸å¿ƒåŸç†ï¼š");
        System.out.println("   REQUIRED      ï¼šåŠ å…¥ç°æœ‰äº‹åŠ¡ â†’ åŒç”Ÿå…±æ­»");
        System.out.println("   REQUIRES_NEW  ï¼šæŒ‚èµ·ç°æœ‰äº‹åŠ¡ â†’ åˆ›å»ºæ–°äº‹åŠ¡ â†’ ç‹¬ç«‹æäº¤");
        System.out.println();
    }
}
